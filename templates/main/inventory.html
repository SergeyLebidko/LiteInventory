{% extends 'main/base.html' %}
{% load static %}

{% block style %}
    <link rel="stylesheet" href="{% static 'main/css/inventory.css' %}">
{% endblock %}

{% block content %}
    <div class="container">
        <div class="group_list"></div>
    </div>
{% endblock %}

{% block scripts %}
    <script type="text/javascript">
        (function ($) {
            $.fn.buildGroupList = function (url, elementsClickHandler) {

                // Функция формирует список (ul), наполняет его наименованиями групп из groupList и вставляет в $container
                function insertGroupToContainer($container, groupList) {
                    if (groupList.length === 0) return;
                    let $listElement = $('<ul>');
                    $listElement.appendTo($container);
                    for (let group of groupList) {
                        $listElement.append($(`<li data-group-id=${group.id}>`).html(`<span>${group.title}</span>`));
                    }
                }

                $.ajax(url).then(rawData => {
                    // Очищаем контейнер, в который будем рендерить группы
                    $('*', this).off().empty();

                    // Первый этап - рендеринг списка корневых групп
                    let work1 = rawData.filter(value => value.group === null);
                    insertGroupToContainer(this, work1);

                    // Второй этап - рендеринг списка подгрупп
                    let work2;
                    let buffer;
                    while (work1.length > 0) {
                        work2 = [];
                        for (let group of work1) {
                            let $container = $(`li[data-group-id=${group.id}]`);
                            buffer = rawData.filter(value => value.group === group.id);
                            if (buffer.length > 0) {
                                insertGroupToContainer($container, buffer);
                                work2 = work2.concat(buffer);
                            }
                        }
                        work1 = work2;
                    }

                    // Назначаем обработчки событий для всех элементов
                    $('span', this).click(elementsClickHandler);
                });

                // Возвращаем значение, чтобы можно было продолжать цепочку jQuery
                return this;
            }
        })(jQuery);

        $('.group_list').buildGroupList('/api/groups/', event => {
            event.stopPropagation();

            console.log($(event.target).closest('li').attr('data-group-id'));

            $('.group_list *').removeClass('selected');
            $(event.target).addClass('selected');
        });
    </script>
{% endblock %}